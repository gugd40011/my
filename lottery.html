<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ° å¹¸è¿æŠ½å¥–</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/tronweb@5.3.1/dist/TronWeb.js"></script>
  <style>
    body {
      background: linear-gradient(to right, #FC466B, #3F5EFB);
      color: #fff;
      min-height: 100vh;
    }
    .card {
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      padding: 2rem;
      color: #333;
    }
    .highlight {
      font-size: 1.8rem;
      font-weight: bold;
      color: #4CAF50;
    }
    .ended-yes { color: green; font-weight: bold; }
    .ended-no { color: red; font-weight: bold; }
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: white;
      font-size: 1.5rem;
    }
    .table th, .table td { vertical-align: middle; }
  </style>
</head>
<body>
<div id="loadingOverlay">è¿æ¥é’±åŒ…ä¸­...</div>
<div class="container mt-5">
  <div class="card text-center">
    <h2>ğŸ° å¹¸è¿æŠ½å¥–</h2>
    <p>æ¯è½®æ»¡ 100 USDT æˆ– 24 å°æ—¶è‡ªåŠ¨å¼€å¥–</p>

    <div class="mb-3">
      <strong>å½“å‰è½®æ¬¡:</strong> <span id="roundId">--</span><br>
      <strong>å¥–æ± æ€»é¢:</strong> <span class="highlight" id="totalAmount">--</span> USDT<br>
      <strong>ä½ çš„æŠ•æ³¨:</strong> <span id="userTickets">0</span> USDT<br>
      <strong>å‰©ä½™æ—¶é—´:</strong> <span id="remaining">--:--:--</span><br>
      <strong>æ˜¯å¦å·²å¼€å¥–:</strong> <span id="isEnded" class="ended-no">--</span><br>
      <strong>å‚ä¸äººæ•°:</strong> <span id="participantCount">--</span>
    </div>

    <div class="input-group mb-3">
      <input type="number" id="ticketAmount" class="form-control" placeholder="æŠ•æ³¨é‡‘é¢ï¼Œæœ€å°‘20 USDT" min="20">
      <button class="btn btn-primary" id="buyBtn">ç«‹å³æŠ•æ³¨</button>
    </div>

    <div>
      <a href="index.html" class="btn btn-outline-light me-2">ğŸ å›é¦–é¡µ</a>
      <button class="btn btn-outline-warning me-2" onclick="showAgentRegister()">ğŸ’¼ æ³¨å†Œä»£ç†</button>
      <button class="btn btn-outline-success" onclick="showUserCenter()">ğŸ‘¤ ä¸ªäººä¸­å¿ƒ</button>
      <button class="btn btn-outline-danger" onclick="reconnectWallet()" style="display: none;" id="reconnectBtn">ğŸ”„ é‡æ–°è¿æ¥é’±åŒ…</button>
    </div>
  </div>

  <div id="userInfo" class="card mt-4" style="display: none;">
    <h3>ğŸ‘¤ ä¸ªäººä¸­å¿ƒ</h3>
    <div id="userInfoContent"></div>
  </div>

  <div id="agentRegister" class="card mt-4" style="display: none;">
    <h3>ğŸ’¼ æ³¨å†Œä»£ç†</h3>
    <div class="mb-3">
      <label class="form-label">ä»£ç†ç­‰çº§</label>
      <select id="agentLevel" class="form-select">
        <option value="1">1çº§ (1000 USDT)</option>
        <option value="2">2çº§ (3000 USDT)</option>
        <option value="3">3çº§ (5000 USDT)</option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">ä¸Šçº¿åœ°å€ï¼ˆå¯é€‰ï¼‰</label>
      <input id="uplineAddress" type="text" class="form-control" placeholder="è¾“å…¥TRONåœ°å€æˆ–ç•™ç©º">
    </div>
    <button class="btn btn-primary" onclick="registerAgent()">ç¡®è®¤æ³¨å†Œ</button>
    <div id="agentRegisterStatus" class="mt-2"></div>
  </div>
</div>

<script>
  const CONTRACT_ADDRESS = 'TU83e2AUfMkuYXMMKKGx7qRzYa95DQPQfz';
  const USDT_ADDRESS = 'TXYZopYRdj2D9XRtbG411XZZ3kM5VkAeBf';
  const DOMAIN = 'https://h3.8123123.xyz';

  const ABI = [
    {
      "inputs":[{"name":"user","type":"address"}],
      "name":"getUserInfo",
      "outputs":[{"components":[
        {"name":"isAgent","type":"bool"},
        {"name":"upline","type":"address"},
        {"name":"level","type":"uint256"},
        {"name":"subordinateCount","type":"uint256"},
        {"name":"totalEarnings","type":"uint256"},
        {"components":[{"name":"roundId","type":"uint256"},{"name":"amount","type":"uint256"},{"name":"timestamp","type":"uint256"}],"name":"bets","type":"tuple[]"}
      ],"name":"","type":"tuple"}],
      "stateMutability":"view","type":"function"
    },
    {
      "inputs":[],"name":"getShareLink",
      "outputs":[{"name":"","type":"string"}],
      "stateMutability":"view","type":"function"
    },
    {
      "inputs":[{"name":"startIndex","type":"uint256"},{"name":"count","type":"uint256"}],
      "name":"getRoundHistory",
      "outputs":[{"components":[
        {"name":"roundId","type":"uint256"},
        {"name":"totalAmount","type":"uint256"},
        {"name":"firstPrize","type":"address"},
        {"name":"firstAmount","type":"uint256"},
        {"name":"secondPrize","type":"address[]"},
        {"name":"secondAmount","type":"uint256"},
        {"name":"timestamp","type":"uint256"}
      ],"name":"","type":"tuple[]"}],
      "stateMutability":"view","type":"function"
    },
    {
      "inputs":[{"name":"upline","type":"address"},{"name":"level","type":"uint256"}],
      "name":"registerAsAgent",
      "outputs":[],"stateMutability":"nonpayable","type":"function"
    },
    {
      "inputs":[{"name":"account","type":"address"}],
      "name":"getAgentSubCount",
      "outputs":[{"name":"","type":"uint256"}],
      "stateMutability":"view","type":"function"
    },
    {
      "inputs":[],"name":"getCurrentRound",
      "outputs":[
        {"name":"roundId","type":"uint256"},
        {"name":"totalAmount","type":"uint256"},
        {"name":"startTime","type":"uint256"},
        {"name":"isEnded","type":"bool"},
        {"name":"remainingTime","type":"uint256"},
        {"name":"userTickets","type":"uint256"}
      ],
      "stateMutability":"view","type":"function"
    },
    {
      "inputs":[],"name":"getParticipantCount",
      "outputs":[{"name":"","type":"uint256"}],
      "stateMutability":"view","type":"function"
    },
    {
      "inputs":[{"name":"amount","type":"uint256"}],
      "name":"buyTicket",
      "outputs":[],"stateMutability":"nonpayable","type":"function"
    },
    {
      "inputs":[{"name":"user","type":"address"}],
      "name":"getRewardDetails",
      "outputs":[
        {"name":"reward","type":"uint256"},
        {"name":"commission","type":"uint256"}
      ],
      "stateMutability":"view","type":"function"
    }
  ];

  const USDT_ABI = [
    {
      "inputs":[{"name":"spender","type":"address"},{"name":"amount","type":"uint256"}],
      "name":"approve",
      "outputs":[{"name":"","type":"bool"}],
      "stateMutability":"nonpayable","type":"function"
    },
    {
      "inputs":[{"name":"account","type":"address"}],
      "name":"balanceOf",
      "outputs":[{"name":"","type":"uint256"}],
      "stateMutability":"view","type":"function"
    },
    {
      "inputs":[{"name":"owner","type":"address"},{"name":"spender","type":"address"}],
      "name":"allowance",
      "outputs":[{"name":"","type":"uint256"}],
      "stateMutability":"view","type":"function"
    }
  ];

  let tronWeb, contract;

  async function initTronWeb() {
    try {
      document.getElementById('loadingOverlay').style.display = 'flex';

      await window.tronLink.request({ method: 'tron_requestAccounts' });

      tronWeb = window.tronWeb;
      if (!tronWeb || !tronWeb.ready) {
        throw new Error("é’±åŒ…æœªè¿æ¥ï¼Œè¯·ç™»å½• TronLink å¹¶åˆ‡æ¢è‡³ Nile æµ‹è¯•ç½‘");
      }

      tronWeb.setFullNode('https://nile.trongrid.io');
      tronWeb.setEventServer('https://nile.trongrid.io');
      contract = await tronWeb.contract(ABI, CONTRACT_ADDRESS);

      if (!tronWeb.defaultAddress.base58) {
        throw new Error("æœªæ£€æµ‹åˆ°é’±åŒ…åœ°å€ï¼Œè¯·é‡æ–°ç™»å½• TronLink");
      }

      console.log("TronWeb åˆå§‹åŒ–æˆåŠŸï¼Œåœ°å€:", tronWeb.defaultAddress.base58);
      document.getElementById('reconnectBtn').style.display = 'none';
      return true;
    } catch (e) {
      console.error("åˆå§‹åŒ–å¤±è´¥:", e);
      let errorMsg = e.message || e;
      if (!window.tronLink) {
        errorMsg = "æœªå®‰è£… TronLinkï¼Œè¯·è®¿é—® https://www.tronlink.org å®‰è£…";
      } else if (!window.tronWeb) {
        errorMsg = "TronLink æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–é‡å¯æµè§ˆå™¨";
      }
      alert(`è¿æ¥é’±åŒ…å¤±è´¥ï¼š${errorMsg}\n\nå»ºè®®ï¼š\n1. å®‰è£…/ç™»å½• TronLink\n2. åˆ‡æ¢è‡³ Nile æµ‹è¯•ç½‘\n3. åˆ·æ–°é¡µé¢`);
      document.getElementById('reconnectBtn').style.display = 'inline-block';
      return false;
    } finally {
      document.getElementById('loadingOverlay').style.display = 'none';
    }
  }

  async function reconnectWallet() {
    document.getElementById('loadingOverlay').style.display = 'flex';
    const success = await initTronWeb();
    if (success) {
      alert("é’±åŒ…è¿æ¥æˆåŠŸï¼");
      debouncedUpdateRoundInfo();
    }
  }

  async function updateRoundInfo() {
    try {
      if (!tronWeb || !tronWeb.ready) return;
      const info = await contract.getCurrentRound().call();
      const count = await contract.getParticipantCount().call();

      const elements = {
        roundId: document.getElementById('roundId'),
        totalAmount: document.getElementById('totalAmount'),
        userTickets: document.getElementById('userTickets'),
        remaining: document.getElementById('remaining'),
        isEnded: document.getElementById('isEnded'),
        participantCount: document.getElementById('participantCount')
      };
      for (const [key, el] of Object.entries(elements)) {
        if (!el) {
          console.error(`DOM å…ƒç´ ç¼ºå¤±: ${key}`);
          return;
        }
      }

      elements.roundId.innerText = Number(info.roundId);
      elements.totalAmount.innerText = (Number(info.totalAmount) / 1e6).toFixed(2);
      elements.userTickets.innerText = (Number(info.userTickets) / 1e6).toFixed(2);
      elements.participantCount.innerText = Number(count);

      const remain = Number(info.remainingTime);
      const h = String(Math.floor(remain / 3600)).padStart(2, '0');
      const m = String(Math.floor((remain % 3600) / 60)).padStart(2, '0');
      const s = String(remain % 60).padStart(2, '0');
      elements.remaining.innerText = `${h}:${m}:${s}`;

      const ended = info.isEnded;
      elements.isEnded.innerText = ended ? 'âœ… å·²å¼€å¥–' : 'â³ æœªå¼€å¥–';
      elements.isEnded.className = ended ? 'ended-yes' : 'ended-no';
    } catch (e) {
      console.error("æ›´æ–°è½®æ¬¡å¤±è´¥:", e);
    }
  }

  let lastUpdate = 0;
  async function debouncedUpdateRoundInfo() {
    const now = Date.now();
    if (now - lastUpdate < 15000) return;
    lastUpdate = now;
    await updateRoundInfo();
  }

  document.getElementById('buyBtn').onclick = async () => {
    if (!tronWeb || !tronWeb.ready) {
      alert("è¯·å…ˆè¿æ¥é’±åŒ…");
      document.getElementById('reconnectBtn').style.display = 'inline-block';
      return;
    }
    const amount = document.getElementById('ticketAmount').value;
    if (!amount || amount < 20) return alert("æœ€å°‘æŠ•æ³¨ 20 USDT");

    document.getElementById('loadingOverlay').style.display = 'flex';
    try {
      // æ£€æŸ¥è½®æ¬¡çŠ¶æ€
      const roundInfo = await contract.getCurrentRound().call();
      if (roundInfo.isEnded) {
        throw new Error("å½“å‰è½®æ¬¡å·²ç»“æŸï¼Œè¯·ç­‰å¾…ä¸‹ä¸€è½®");
      }
      if (Number(roundInfo.totalAmount) < 20 * 1e6) {
        console.warn("å¥–æ± ä¸è¶³ 20 USDTï¼Œå¯èƒ½æ— æ³•è§¦å‘å¼€å¥–");
        alert("å¥–æ± ä¸è¶³ 20 USDTï¼ŒæŠ•æ³¨å¯èƒ½ä¸è§¦å‘å¼€å¥–ï¼Œç»§ç»­ï¼Ÿ");
      }
      console.log("è½®æ¬¡çŠ¶æ€:", roundInfo);

      // æ£€æŸ¥èƒ½é‡
      const energyNeeded = Number(roundInfo.totalAmount) >= 100 * 1e6 ? 150000 : 50000;
      const response = await fetch(`https://nile.trongrid.io/wallet/getaccountresource?address=${tronWeb.defaultAddress.hex}`);
      const data = await response.json();
      const energyAvailable = data.EnergyLimit - (data.EnergyUsed || 0);
      if (energyAvailable < energyNeeded) {
        throw new Error(`èƒ½é‡ä¸è¶³ï¼Œå½“å‰: ${energyAvailable}ï¼Œéœ€: ${energyNeeded}ï¼Œè¯·è´¨æŠ¼ TRXï¼ˆè®¿é—® https://nile.tronscan.org/#/walletï¼‰`);
      }
      console.log("èƒ½é‡æ£€æŸ¥é€šè¿‡ï¼Œå½“å‰:", energyAvailable, "éœ€:", energyNeeded);

      // æ£€æŸ¥ USDT ä½™é¢å’Œæˆæƒ
      const usdt = await tronWeb.contract(USDT_ABI, USDT_ADDRESS);
      const amountInSun = parseInt(amount * 1e6);
      const balance = await usdt.balanceOf(tronWeb.defaultAddress.hex).call();
      if (parseInt(balance) < amountInSun) throw new Error(`USDT ä½™é¢ä¸è¶³ï¼Œå½“å‰: ${(parseInt(balance) / 1e6).toFixed(2)} USDTï¼Œéœ€: ${amount} USDT`);
      const allowance = await usdt.allowance(tronWeb.defaultAddress.hex, CONTRACT_ADDRESS).call();
      if (parseInt(allowance) < amountInSun) {
        console.log("æˆæƒä¸è¶³ï¼Œé‡æ–°æˆæƒ:", amountInSun / 1e6, "USDT");
        await usdt.approve(CONTRACT_ADDRESS, amountInSun).send({ feeLimit: 20000000 });
        console.log("USDT æˆæƒæˆåŠŸ");
      } else {
        console.log("å·²æœ‰è¶³å¤Ÿæˆæƒ:", parseInt(allowance) / 1e6, "USDT");
      }

      // æ‰§è¡ŒæŠ•æ³¨
      await contract.buyTicket(amountInSun).send({ feeLimit: 50000000 });
      console.log("buyTicket æˆåŠŸï¼Œé‡‘é¢:", amountInSun / 1e6, "USDT");

      alert("æŠ•æ³¨æˆåŠŸï¼ç­‰å¾…å¼€å¥–ï¼");
      document.getElementById('ticketAmount').value = '';
      debouncedUpdateRoundInfo();
    } catch (err) {
      let errorMsg = err.message || err;
      if (err.includes("OUT_OF_ENERGY")) {
        errorMsg = "èƒ½é‡ä¸è¶³ï¼Œè¯·è´¨æŠ¼ TRXï¼ˆè®¿é—® https://nile.tronscan.org/#/walletï¼‰";
      } else if (err.includes("REVERT")) {
        errorMsg = "åˆçº¦æ‰§è¡Œå¤±è´¥ï¼Œå¯èƒ½åŸå› ï¼šUSDT ä½™é¢ä¸è¶³ã€æˆæƒå¤±è´¥ã€è½®æ¬¡å·²ç»“æŸæˆ–å¥–æ± ä¸è¶³";
      } else if (err === "Confirmation declined by user") {
        errorMsg = "è¯·åœ¨ TronLink ç¡®è®¤äº¤æ˜“";
      }
      console.error("buyTicket å¤±è´¥è¯¦æƒ…:", err);
      alert(`æŠ•æ³¨å¤±è´¥: ${errorMsg}\näº¤æ˜“å“ˆå¸Œ: ${err.transactionHash || 'æœªçŸ¥'}`);
    } finally {
      document.getElementById('loadingOverlay').style.display = 'none';
    }
  };

  async function showUserCenter() {
    if (!tronWeb || !tronWeb.ready) {
      alert("è¯·å…ˆè¿æ¥é’±åŒ…");
      document.getElementById('reconnectBtn').style.display = 'inline-block';
      return;
    }
    const userInfoDiv = document.getElementById('userInfo');
    const contentDiv = document.getElementById('userInfoContent');
    userInfoDiv.style.display = 'block';
    contentDiv.innerHTML = '<p class="text-muted">åŠ è½½ä¸­...</p>';
    document.getElementById('loadingOverlay').style.display = 'flex';

    try {
      const userAddress = tronWeb.defaultAddress.base58;
      let userInfo, shareLink, history, rewardDetails;

      try {
        userInfo = await contract.getUserInfo(userAddress).call();
        console.log("getUserInfo åŸå§‹æ•°æ®:", userInfo);
      } catch (e) {
        console.error("getUserInfo å¤±è´¥:", e);
        throw new Error(`getUserInfo å¤±è´¥: ${e.message || e}`);
      }

      try {
        rewardDetails = await contract.getRewardDetails(userAddress).call();
        console.log("getRewardDetails åŸå§‹æ•°æ®:", rewardDetails);
      } catch (e) {
        console.error("getRewardDetails å¤±è´¥:", e);
        rewardDetails = { reward: 0, commission: 0 };
      }

      if (!userInfo.isAgent) {
        shareLink = `<span class="text-warning">è¯·æ³¨å†Œä»£ç†ä»¥è·å–åˆ†äº«é“¾æ¥</span><br><button class="btn btn-warning mt-2" onclick="showAgentRegister()">ç«‹å³æ³¨å†Œä»£ç†</button>`;
      } else {
        shareLink = `<span class="text-info">åˆ†äº«é“¾æ¥ï¼š${DOMAIN}/agent.html?ref=${userAddress}</span>`;
      }

      try {
        history = await contract.getRoundHistory(0, 5).call();
        console.log("getRoundHistory åŸå§‹æ•°æ®:", history);
      } catch (e) {
        console.error("getRoundHistory å¤±è´¥:", e);
        history = [];
      }

      if (!userInfo) {
        contentDiv.innerHTML = `<div class="alert alert-danger">åŠ è½½å¤±è´¥ï¼šç”¨æˆ·ä¿¡æ¯ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•</div>`;
        return;
      }

      const level = Number(userInfo.level) || 0;
      const levelDisplay = (level >= 1 && level <= 3) ? level : '<span class="text-warning">å¼‚å¸¸ï¼Œè¯·é‡æ–°æ³¨å†Œ</span>';
      const uplineAddress = userInfo.upline === "0x0000000000000000000000000000000000000000" ? "æ— " : (tronWeb.address.fromHex(userInfo.upline) || '<span class="text-warning">åœ°å€å¼‚å¸¸</span>');
      const totalEarnings = Number(userInfo.totalEarnings) / 1e6;
      const earningsDisplay = totalEarnings > 0 ? `${totalEarnings.toFixed(2)} USDT` : '<span class="text-info">æš‚æ— æ”¶ç›Šï¼Œé‚€è¯·ä¸‹çº¿æˆ–æŠ•æ³¨</span>';
      const subordinateList = userInfo.subordinateCount > 0 ? `äººæ•°ï¼š${userInfo.subordinateCount}ï¼Œè¯·è”ç³»æ”¯æŒè·å–è¯¦æƒ…<span class="text-warning">ï¼ˆå¯èƒ½å­˜åœ¨å¼‚å¸¸æ•°æ®ï¼‰</span>` : "æ— ";
      const rewardDetailsDisplay = `å½©ç¥¨å¥–åŠ±ï¼š${(Number(rewardDetails.reward) / 1e6).toFixed(2)} USDT<br>ä»£ç†ä½£é‡‘ï¼š${(Number(rewardDetails.commission) / 1e6).toFixed(2)} USDT`;

      contentDiv.innerHTML = `
        <h4>åŸºæœ¬ä¿¡æ¯</h4>
        <p><strong>æ˜¯å¦ä¸ºä»£ç†:</strong> ${userInfo.isAgent ? "æ˜¯" : "å¦"}</p>
        <p><strong>ä¸Šçº¿ä»£ç†:</strong> ${uplineAddress}</p>
        <p><strong>ä»£ç†ç­‰çº§:</strong> ${levelDisplay}</p>
        <p><strong>ä¸‹çº¿äººæ•°:</strong> ${subordinateList}</p>
        <p><strong>æ€»æ”¶ç›Š:</strong> ${earningsDisplay}</p>
        <p><strong>å¥–åŠ±è¯¦æƒ…:</strong><br>${rewardDetailsDisplay}</p>
        <p><strong>åˆ†äº«é“¾æ¥:</strong> ${shareLink}</p>
        <h4 class="mt-4">æŠ•æ³¨è®°å½•</h4>
        <table class="table table-striped">
          <thead>
            <tr><th>è½®æ¬¡</th><th>é‡‘é¢ (USDT)</th><th>æ—¶é—´</th></tr>
          </thead>
          <tbody>
            ${userInfo.bets && userInfo.bets.length ? userInfo.bets.map(bet => `
              <tr>
                <td>${Number(bet.roundId)}</td>
                <td>${(Number(bet.amount) / 1e6).toFixed(2)}</td>
                <td>${new Date(Number(bet.timestamp) * 1000).toLocaleString()}</td>
              </tr>
            `).join("") : '<tr><td colspan="3" class="text-center">æš‚æ— è®°å½•</td></tr>'}
          </tbody>
        </table>
        <h4 class="mt-4">å¼€å¥–å†å²</h4>
        <table class="table table-striped">
          <thead>
            <tr><th>è½®æ¬¡</th><th>å¥–æ±  (USDT)</th><th>ä¸€ç­‰å¥–</th><th>é‡‘é¢</th><th>äºŒç­‰å¥–</th><th>é‡‘é¢/äºº</th><th>æ—¶é—´</th></tr>
          </thead>
          <tbody>
            ${history && history.length ? history.map(round => `
              <tr>
                <td>${Number(round.roundId)}</td>
                <td>${(Number(round.totalAmount) / 1e6).toFixed(2)}</td>
                <td>${tronWeb.address.fromHex(round.firstPrize)}</td>
                <td>${(Number(round.firstAmount) / 1e6).toFixed(2)}</td>
                <td>${round.secondPrize.length > 0 ? round.secondPrize.map(addr => tronWeb.address.fromHex(addr)).join(", ") : "æ— "}</td>
                <td>${Number(round.secondAmount) > 0 ? (Number(round.secondAmount) / 1e6).toFixed(2) : '<span class="text-warning">0.00</span>'}</td>
                <td>${new Date(Number(round.timestamp) * 1000).toLocaleString()}</td>
              </tr>
            `).join("") : '<tr><td colspan="7" class="text-center">æš‚æ— è®°å½•</td></tr>'}
          </tbody>
        </table>
      `;
    } catch (err) {
      console.error("ä¸ªäººä¸­å¿ƒåŠ è½½å¤±è´¥:", err);
      contentDiv.innerHTML = `<div class="alert alert-danger">åŠ è½½å¤±è´¥ï¼šè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•ï¼ˆ${err.message || err}ï¼‰</div>`;
    } finally {
      document.getElementById('loadingOverlay').style.display = 'none';
    }
  }

  async function showAgentRegister() {
    if (!tronWeb || !tronWeb.ready) {
      alert("è¯·å…ˆè¿æ¥é’±åŒ…");
      document.getElementById('reconnectBtn').style.display = 'inline-block';
      return;
    }
    document.getElementById('agentRegister').style.display = 'block';
    document.getElementById('agentRegisterStatus').innerHTML = '';
  }

  async function registerAgent() {
    if (!tronWeb || !tronWeb.ready) {
      alert("è¯·å…ˆè¿æ¥é’±åŒ…");
      document.getElementById('reconnectBtn').style.display = 'inline-block';
      return;
    }
    const statusDiv = document.getElementById('agentRegisterStatus');
    statusDiv.innerHTML = '';
    document.getElementById('loadingOverlay').style.display = 'flex';

    try {
      const usdt = await tronWeb.contract(USDT_ABI, USDT_ADDRESS);
      const level = document.getElementById('agentLevel').value;
      const uplineInput = document.getElementById('uplineAddress').value.trim();
      let upline = "0x0000000000000000000000000000000000000000";
      if (uplineInput && !uplineInput.match(/^T[1-9A-HJ-NP-Za-km-z]{33}$/)) {
        throw new Error("è¯·è¾“å…¥æœ‰æ•ˆçš„ TRON åœ°å€ï¼ˆä»¥ T å¼€å¤´ï¼Œ34 ä½ï¼‰æˆ–ç•™ç©º");
      }
      if (uplineInput) upline = uplineInput;

      const fee = level == 1 ? 1000 * 1e6 : level == 2 ? 3000 * 1e6 : 5000 * 1e6;
      const balance = await usdt.balanceOf(tronWeb.defaultAddress.hex).call();
      if (parseInt(balance) < fee) throw new Error("USDT ä½™é¢ä¸è¶³");

      await usdt.approve(CONTRACT_ADDRESS, fee).send({ feeLimit: 20000000 });
      await contract.registerAsAgent(upline, level).send({ feeLimit: 20000000 });

      statusDiv.innerHTML = '<div class="alert alert-success">æ³¨å†ŒæˆåŠŸï¼</div>';
      alert("ä»£ç†æ³¨å†ŒæˆåŠŸï¼Œè¯·è¿”å›ä¸ªäººä¸­å¿ƒæŸ¥çœ‹åˆ†äº«é“¾æ¥");
    } catch (err) {
      console.error("ä»£ç†æ³¨å†Œå¤±è´¥:", err);
      statusDiv.innerHTML = `<div class="alert alert-danger">æ³¨å†Œå¤±è´¥ï¼š${err === "Confirmation declined by user" ? "è¯·åœ¨ TronLink ç¡®è®¤äº¤æ˜“" : err.message || err}</div>`;
    } finally {
      document.getElementById('loadingOverlay').style.display = 'none';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    try {
      setTimeout(async () => {
        const success = await initTronWeb();
        if (success) {
          debouncedUpdateRoundInfo();
          setInterval(debouncedUpdateRoundInfo, 1000);
        }
      }, 3000);
    } catch (e) {
      console.error("åˆå§‹åŒ–å¤±è´¥:", e);
      alert("é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥ç½‘ç»œ");
    }
  });
</script>
</body>
</html>